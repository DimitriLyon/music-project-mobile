<!doctype html> <!-- document declaration  -->
<html>
<head>
<link rel="stylesheet" href="client/style.css">
<!--viewport allows for porper resizing on mobile devices ,K.-->
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<!--<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script> -->
<script src="/socket.io/socket.io.js"></script>
<script src="client/js/zoneOne.js"></script>
<script src="client/js/zoneTwo.js"></script>
<script src="client/js/zoneThree.js"></script>
<script src="client/js/zoneFour.js"></script>
<script src="client/js/zoneFive.js"></script>
<script src="client/js/zoneSix.js"></script>
<script src="client/js/zoneSeven.js"></script>
<script src="client/js/zoneEight.js"></script>
<script src="client/js/zoneNine.js"></script>
<script src="client/js/OfficeZone.js"></script>

</head>
<body>
    
    <h1 style="color:white">INTERACTIVE MUSIC! </h1>

    <!-- pauses all current tracks -->
    
    <audio id="audioContainer1">
        <source src="client/audios/Ex1_sprite_12.03.20-zone1.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer2">
        <source src="client/audios/Ex1_sprite_12.03.20-zone2.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer3">
        <source src="client/audios/Ex1_sprite_12.03.20-zone3.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer4">
        <source src="client/audios/Ex1_sprite_12.03.20-zone4.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer5">
        <source src="client/audios/Ex1_sprite_12.03.20-zone5.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer6">
        <source src="client/audios/Ex1_sprite_12.03.20-zone6.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer7">
        <source src="client/audios/Ex1_sprite_12.03.20-zone7.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer8">
        <source src="client/audios/Ex1_sprite_12.03.20-zone8.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer9">
        <source src="client/audios/Ex1_sprite_12.03.20-zone9.mp3" type="audio/mpeg">
    </audio>
    <audio id="audioContainer10">
        <source src="client/audios/Ex1_sprite_12.03.20-zone10.mp3" type="audio/mpeg">
    </audio>
    
    <button type="button" onclick="playMusic(), connectCtx()"> DON'T PRESS THIS ! is only for testing</button>
    
    <button type="button" onclick="GPS(), connectCtx()">START ! (you may need to press this twice for the GPS to work)</button>
    
    <p style="text-align:left; color: white; " >Frequency low pass Track #1</p>

    <input type='range' max=20000 value=10 step=1 id='FrequencySlider1'>
    <span id='FrequencyLabel1'></span>

    <p style="text-align:left; color: white; " >Frequency high pass Track #1</p>

    <input type='range' max=20000 value=10 step=1 id='FHSlider1'>
    <span id='FHLabel1'></span>

    <p style="text-align:left; color: white; ">Fre Gain Track #1</p>

    <input type='range' max=25 value=1 step=1 id='GainSlider1'>
    <span id='GainLabel1'></span>

    <p style="text-align:left; color: white; ">Frequency low pass Track #8</p>

    <input type='range' max=20000 value=10 step=1 id='FrequencySlider8'>
    <span id='FrequencyLabel8'></span>

    <p style="text-align:left; color: white; " >Frequency high pass Track #8</p>

    <input type='range' max=20000 value=10 step=1 id='FHSlider8'>
    <span id='FHLabel8'></span>

    <p style="text-align:left; color: white; ">Fre Gain Track #8</p>

    <input type='range' max=25 value=1 step=1 id='GainSlider8'>
    <span id='GainLabel8'></span>

    <p style="text-align:left; color: white; ">Frequency low pass Track #9</p>

    <input type='range' max=20000 value=10 step=1 id='FrequencySlider9'>
    <span id='FrequencyLabel9'></span>

    <p style="text-align:left; color: white; " >Frequency high pass Track #9</p>

    <input type='range' max=20000 value=10 step=1 id='FHSlider9'>
    <span id='FHLabel9'></span>

    <p style="text-align:left; color: white; ">Fre Gain Track #9</p>

    <input type='range' max=25 value=1 step=1 id='GainSlider9'>
    <span id='GainLabel9'></span>

    <link rel="stylesheet"
        href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
   
</div>
 
<script>
//connect to the server with the associated port, url + domain
const socket = io();

const limitOfUsers = 40;

var filterLimiter = 20000/limitOfUsers;

var GPS = function(){
    var locat = getLocation();
    socket.emit('userCoords',{
        lat:locat.latitude,
        lng:locat.longitude
    });
};

//this is just a message testing server.
socket.on('serverMsg', function(data){
    console.log(data.msg);
});

socket.on('newPos', function(data){

    if(data[0].zones[0]>0 & data[0].zones[0] <= limitOfUsers ){
        audio1.volume = 1;
        biQLow1.frequency.value = filterLimiter*(data[0].zones[0]);
        audio1.play();
    }
    else{audio1.volume =0;}

    if(data[0].zones[1]>0  & data[0].zones[1] <= limitOfUsers){
        audio2.volume = 1;
        biQLow2.frequency.value = filterLimiter*(data[0].zones[1]);
        audio2.play();
    }
    else{audio2.volume =0;}
    
    if(data[0].zones[2]>0 & data[0].zones[2] <= limitOfUsers){
        audio3.volume = 1;
        biQLow3.frequency.value = filterLimiter*(data[0].zones[2]);
        audio3.play();
    }
    else{audio3.volume =0;}
    
    if(data[0].zones[3]>0 & data[0].zones[3] <= limitOfUsers){
        audio4.volume = 1;
        biQLow4.frequency.value = filterLimiter*(data[0].zones[3]);
        audio4.play();
    }
    else{audio4.volume =0;}
    
    if(data[0].zones[4]>0 & data[0].zones[4] <= limitOfUsers){
        audio5.volume = 1;
        biQLow5.frequency.value = filterLimiter*(data[0].zones[4]);
        audio5.play();
    }
    else{audio5.volume =0;}
    
    if(data[0].zones[9]>0 & data[0].zones[9] <= limitOfUsers){
        audio6.volume = 1;
        biQLow6.frequency.value = filterLimiter*(data[0].zones[9]);//dont forget to return these to the normal value
        audio6.play();
    }
    else{audio6.volume =0;}
    
    if(data[0].zones[9]>0 & data[0].zones[9] <= limitOfUsers){
        audio7.volume = 1;
        biQLow7.frequency.value = filterLimiter*(data[0].zones[9]);//dont forget to return these to the normal value
        audio7.play();
    }
    else{audio7.volume =0;}
    
    if(data[0].zones[9]>0 & data[0].zones[9] <= limitOfUsers){
        audio8.volume = 1;
        biQLow8.frequency.value = filterLimiter*(data[0].zones[9]);//dont forget to return these to the normal value
        audio8.play();
    }
    else{audio8.volume =0;}
    
    if(data[0].zones[9]>0 & data[0].zones[9] <= limitOfUsers){
        audio9.volume = 1;
        biQLow9.frequency.value = filterLimiter*(data[0].zones[9]);//dont forget to return these to the normal value
        audio9.play();
    }
    else{audio9.volume =0;}

    if(data[0].zones[9]>0 & data[0].zones[9] <= limitOfUsers){
        audio10.volume = 1;
        biQLow10.frequency.value = filterLimiter*(data[0].zones[9]);//dont forget to return these to the normal value
        console.log(biQLow10.frequency.value);
        audio10.play();
    }
    else if (data[0].zones[9]<=0){audio10.volume =0;}
    
    for(var i =0; i < data.length; i++){
        
        console.log('userPos',data[0].zones, data[i].coord, data[0].zones[9]);
    }
    
});

ctx = new AudioContext();

const audio1 = document.getElementById("audioContainer1");
const audio2 = document.getElementById("audioContainer2");
const audio3 = document.getElementById("audioContainer3");
const audio4 = document.getElementById("audioContainer4");
const audio5 = document.getElementById("audioContainer5");
const audio6 = document.getElementById("audioContainer6");
const audio7 = document.getElementById("audioContainer7");
const audio8 = document.getElementById("audioContainer8");
const audio9 = document.getElementById("audioContainer9");
const audio10 = document.getElementById("audioContainer10");


var ctxConnected = false;

var biQLow1 = ctx.createBiquadFilter();
var gainNode1 = ctx.createGain();

var biQLow2 = ctx.createBiquadFilter();
var gainNode2 = ctx.createGain();

var biQLow3 = ctx.createBiquadFilter();
var gainNode3 = ctx.createGain();

var biQLow4 = ctx.createBiquadFilter();
var gainNode4 = ctx.createGain();

var biQLow5 = ctx.createBiquadFilter();
var gainNode5 = ctx.createGain();

var biQLow6 = ctx.createBiquadFilter();
var gainNode6 = ctx.createGain();

var biQLow7 = ctx.createBiquadFilter();
var gainNode7 = ctx.createGain();

var biQLow8 = ctx.createBiquadFilter();
var gainNode8 = ctx.createGain();

var biQLow9 = ctx.createBiquadFilter();
var gainNode9 = ctx.createGain();

var biQLow10 = ctx.createBiquadFilter();
var gainNode10 = ctx.createGain();

function connectCtx(){
    if(ctxConnected){
        console.log("audio contexts already initialized");
    }
    else if(!ctxConnected){
        
        ctx.resume();
        
        var audioSource1 = ctx.createMediaElementSource(audio1);
        var audioSource2 = ctx.createMediaElementSource(audio2);
        var audioSource3 = ctx.createMediaElementSource(audio3);
        var audioSource4 = ctx.createMediaElementSource(audio4);
        var audioSource5 = ctx.createMediaElementSource(audio5);
        var audioSource6 = ctx.createMediaElementSource(audio6);
        var audioSource7 = ctx.createMediaElementSource(audio7);
        var audioSource8 = ctx.createMediaElementSource(audio8);
        var audioSource9 = ctx.createMediaElementSource(audio9);
        var audioSource10 = ctx.createMediaElementSource(audio10);

        audioSource1.connect(biQLow1).connect(gainNode1).connect(ctx.destination);

        biQLow1.type = "lowpass"; //low pass first, middel c is 250 hz
        biQLow1.frequency.value = 0; 
        //biQLow1.gain.value = 25;

        audioSource2.connect(biQLow2).connect(gainNode2).connect(ctx.destination);

        biQLow2.type = "lowpass";
        biQLow2.frequency.value = 0;
        //biQLow2.gain.value = 25;        

        audioSource3.connect(biQLow3).connect(gainNode3).connect(ctx.destination);

        biQLow3.type = "lowpass";
        biQLow3.frequency.value = 0;
        //biQLow3.gain.value = 25;

        audioSource4.connect(biQLow4).connect(gainNode4).connect(ctx.destination);

        biQLow4.type = "lowpass";
        biQLow4.frequency.value = 0;
        biQLow4.gain.value = 25;
        //biQLow4.detune.value = 100;

        audioSource5.connect(biQLow5).connect(gainNode5).connect(ctx.destination);

        biQLow5.type = "lowpass";
        biQLow5.frequency.value = 0;
        biQLow5.gain.value = 25;
        //biQLow5.detune.value = 100;

        audioSource6.connect(biQLow6).connect(gainNode6).connect(ctx.destination);

        biQLow6.type = "lowpass";
        biQLow6.frequency.value = 0;
        biQLow6.gain.value = 25;
        //biQLow6.detune.value = 100;

        audioSource7.connect(biQLow7).connect(gainNode7).connect(ctx.destination);

        biQLow7.type = "lowpass";
        biQLow7.frequency.value = 0;
        biQLow7.gain.value = 25;
        //biQLow7.detune.value = 100;

        audioSource8.connect(biQLow8).connect(gainNode8).connect(ctx.destination);
        
        biQLow8.type = "lowpass";
        biQLow8.frequency.value = 0;
        //biQLow8.gain.value = 25;
       
        audioSource9.connect(biQLow9).connect(gainNode9).connect(ctx.destination);

        biQLow9.type = "lowpass";
        biQLow9.frequency.value = 0;
        //biQLow9.gain.value = 25;

        audioSource10.connect(biQLow10).connect(gainNode10).connect(ctx.destination);
        
        biQLow10.type = "lowpass";
        biQLow10.frequency.value = 0;
        //biQLow10.gain.value = 25;

        ctxConnected = true;

    }
}



//delete it after debug

FrequencySlider1.oninput = function(){
    FrequencyLabel1.innerHTML = this.value;
    biQLow1.frequency.value = this.value;
}

FHSlider1.oninput = function(){
    FHLabel1.innerHTML = this.value;
    biQHigh1.frequency.value = this.value;
}

GainSlider1.oninput = function(){
    GainLabel1.innerHTML = this.value;
    gainNode1.gain.value = this.value;
}

FrequencySlider8.oninput = function(){
    FrequencyLabel8.innerHTML = this.value;
    biQLow8.frequency.value = this.value;
}

FHSlider8.oninput = function(){
    FHLabel8.innerHTML = this.value;
    biQHigh8.frequency.value = this.value;
}

GainSlider8.oninput = function(){
    GainLabel8.innerHTML = this.value;
    gainNode8.gain.value = this.value;
}

FrequencySlider9.oninput = function(){
    FrequencyLabel9.innerHTML = this.value;
    biQLow9.frequency.value = this.value;
}

FHSlider9.oninput = function(){
    FHLabel9.innerHTML = this.value;
    biQHigh9.frequency.value = this.value;
}

GainSlider9.oninput = function(){
    GainLabel9.innerHTML = this.value;
    gainNode9.gain.value = this.value;
}

audio1.loop = true;
audio2.loop = true;
audio3.loop = true;
audio4.loop = true;
audio5.loop = true;
audio6.loop = true;
audio7.loop = true;
audio8.loop = true;
audio9.loop = true;

audio1.volume = 0;
audio2.volume = 0;
audio3.volume = 0;
audio4.volume = 0;
audio5.volume = 0;
audio6.volume = 0;
audio7.volume = 0;
audio8.volume = 0;
audio9.volume = 0;

//play and loop all audios

// function determines if coordinates are inside a polygon.
function inside(point, vs) {
    // ray-casting algorithm based on
    // https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html/pnpoly.html
    
    var x = point[0], y = point[1];
    
    var inside = false;
    for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        var xi = vs[i][0], yi = vs[i][1];
        var xj = vs[j][0], yj = vs[j][1];
        
        var intersect = ((yi > y) != (yj > y))
            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
    }
    
    return inside;
}


var verZoneOne = [
    [31.771011, -106.505353],
    [31.771572, -106.50448],
    [31.770785, -106.5033789],
    [31.769928, -106.505274]
];

var verZoneTwo = [
    [31.770973, -106.505293],
    [31.771267, -106.50482],
    [31.770883, -106.504641]
];

var verZoneThree = [
    [31.770973, -106.505293],
    [31.770883, -106.504641],
    [31.770587, -106.505225]
];

var verZoneFour = [
    [31.770465, -106.505247],
    [31.770530, -106.504931],
    [31.770342, -106.504719],
    [31.770162, -106.50518]
];

var verZoneFive = [
    [31.770883, -106.504641],
    [31.770732, -106.503878],
    [31.770481, -106.504262],
    //[zone_five.get_fourth_lat, zone_five.get_fourth_lng]
];

var verZoneSix = [
    [31.770982, -106.505153],
    [31.771264, -106.504611],
    [31.770737, -106.504089],
    [31.770392, -106.504567]
];

var verZoneSeven = [
    [31.770957, -106.50495],
    [31.771119, -106.504621],
    [31.770771, -106.504239],
    [31.770562, -106.504508]
];

var verZoneEight = [
    [31.771290, -106.504835],
    [31.771269, -106.504464],
    [31.770887, -106.504642],
    //[zone_eight.get_fourth_lat, zone_eight.get_fourth_lng]
];

var verZoneNine = [
    [31.770863, -106.504678],
    [31.770931, -106.504596],
    [31.770857, -106.504508],
    [31.770803, -106.504609]
];

var verOfficeZone = [
    [31.7810, -106.489],
    [31.7790, -106.4875],
    [31.7820, -106.4867]
];



var intervalInit = false;
function callplayMusic(){
    if(intervalInit == false){
        console.log("Interval initialized")
        var intervalid = setInterval(playMusic(), 500)
        intervalInit = true;
    }   
    
}
// function handles the logic of the zones in the map.
function playMusic(){
    
    updated = getLocation();

    lat = updated.latitude;
    lng = updated.longitude;

    console.log(lat);
    console.log(lng);

    if(inside([lat, lng],verZoneOne)){
        console.log("In location 1");
        audio1.play();
        audio1.volume = 1;
    } 
    else{
        console.log("Not in location 1");
        audio1.volume = 0; 
    }

    if(inside([lat, lng],verZoneTwo)){
        console.log("In location 2");
        audio2.play();
        audio2.volume = 1;
    }

    else{
        console.log("Not in location 2");
        audio2.volume = 0; 
    }
    if(inside([lat, lng],verZoneThree)){
        console.log("In location 3");
        audio3.play();
        audio3.volume = 1;
    } 
    else{
        console.log("Not in location 3");
        audio3.volume = 0; 
    }
    if(inside([lat, lng],verZoneFour)){
        console.log("In location 4");
        audio4.play();
        audio4.volume = 1;
    } 
    else{
        console.log("Not in location 4");
        audio4.volume = 0; 
    }
    if(inside([lat, lng],verZoneFive)){
        console.log("In location 5");
        audio5.play();
        audio5.volume = 1;
    } 
    else{
        console.log("Not in location 5");
        audio5.volume = 0; 
    }
    if(inside([lat, lng],verZoneSix)){
        console.log("In location 6");
        audio6.play();
        audio6.volume = 1;
    } 
    else{
        console.log("Not in location 6");
        audio6.volume = 0; 
    }
    if(inside([lat, lng],verZoneSeven)){
        console.log("In location 7");
        audio7.play();
        audio7.volume = 1;
    } 
    else{
        console.log("Not in location 7");
        audio7.volume = 0; 
    }
    if(inside([lat, lng],verOfficeZone)){
        console.log("In location 8");
        audio8.play();
        audio8.volume = 1;
        
    } 
    else{
        console.log("Not in location 8");
        audio8.volume = 0; 
    }
    
    if(inside([lat, lng],verOfficeZone)){
        console.log("In location 9");
        audio9.play();
        audio9.volume = 1;
    } 
    else{
        console.log("Not in location 9");
        audio9.volume = 0; 
    }

    if(inside([lat, lng],verOfficeZone)){
        console.log("In OFFICE");
        audio1.play();
        audio1.volume = 1;
    } 
    else{
        console.log("Not in OFFICE");
        audio1.volume = 0; 
    }
    
}

var coordinates = {};

async function showLocation(position) {
    // obtain coordinates from the API.
    var lat = position.coords.latitude;
    var lng = position.coords.longitude;
    // coordinates stores new coordinates.
    coordinates = {latitude: lat, longitude: lng};
    // print into the HTML file.
    //document.getElementById('latitude').textContent = lat;
    //document.getElementById('longitude').textContent = lng;

}

function errorHandler(err) {
    if(err.code == 1) {
        alert("Error: Access is denied!");
    } else if( err.code == 2) {
        alert("Error: Position is unavailable!");
    }
}
//no request for iOS
//https://stackoverflow.com/questions/48293914/geolocation-in-javascript-on-ios-safari
function getLocation() {
    if(navigator.geolocation) {
       // timeout at 60000 milliseconds (5? seconds)
       var options = {timeout:5000};
       navigator.geolocation.getCurrentPosition(showLocation, errorHandler, options);
       // return the updated variables.
       return coordinates;
    } else {
       alert("Sorry, browser does not support geolocation!");
    }
}

</script>
</body>
</html>